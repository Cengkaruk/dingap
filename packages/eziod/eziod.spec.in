# EZIOd RPM spec
%define debug 1

Name: eziod
Version: @VER_MAJOR@.@VER_MINOR@
Release: @VER_RELEASE@%{dist}
Vendor: ClearFoundation
License: GPL
Group: System Environment/Daemons
Packager: ClearFoundation
Source: %{name}-%{version}.tar.gz
BuildRoot: /var/tmp/%{name}-%{version}
Requires: lm_sensors kmod-network-bypass kernel >= 2.6.18-164.11.1.v5
Requires(post): /sbin/chkconfig
Requires(preun): /sbin/chkconfig
BuildRequires: lm_sensors-devel
Summary: EZIO-300 LCD panel server
%description
EZIOd is a daemon which controls the EZIO-300 LCD panel and buttons.

%prep

%setup

%build

%if %{debug}
CFLAGS="-g -O2 -pipe"
%else
CFLAGS="-O2 -s -pipe -mtune=%{_target_cpu}"
%endif

export CFLAGS="$CFLAGS"
export CXXFLAGS="$CFLAGS"

make

# Install
%install

rm -rf $RPM_BUILD_ROOT

mkdir -p -m 755 $RPM_BUILD_ROOT/usr/sbin
mkdir -p -m 755 $RPM_BUILD_ROOT/etc/init.d
mkdir -p -m 755 $RPM_BUILD_ROOT/etc/sysconfig/modules
mkdir -p -m 755 $RPM_BUILD_ROOT/usr/share/eziod

cp eziod $RPM_BUILD_ROOT/usr/sbin
cp eziod.conf $RPM_BUILD_ROOT/etc
cp eziod.init $RPM_BUILD_ROOT/etc/init.d/eziod
cp eziod.modules $RPM_BUILD_ROOT/etc/sysconfig/modules/
cp scripts/*.php $RPM_BUILD_ROOT/usr/share/eziod/

# Post install
%post
/sbin/chkconfig --add eziod 2>&1 || :
/sbin/modprobe network-bypass board=CAR3000 >/dev/null 2>&1 || :
/sbin/modprobe w83627ehf >/dev/null 2>&1 || :

# Pre un-install
%preun
if [ "$1" = 0 ]; then
    /sbin/chkconfig --del eziod
fi

# Post un-install
%postun
if [ -f /var/lock/subsys/eziod ]; then
    killall -TERM eziod 2>&1 || :
    sleep 2
fi

# Clean-up
%clean
[ "$RPM_BUILD_ROOT" != "/" ] && rm -rf $RPM_BUILD_ROOT

# Files
%files
%defattr(-,root,root)
%attr(0755,root,root)/usr/sbin/eziod
%config(noreplace)/etc/eziod.conf
%attr(0755,root,root)/etc/init.d/eziod
%attr(0755,root,root)/etc/sysconfig/modules/eziod.modules
%attr(0644,root,root)/usr/share/eziod/*.php

