<?php

///////////////////////////////////////////////////////////////////////////////
//
// Copyright 2003-2009 Point Clark Networks.
//
///////////////////////////////////////////////////////////////////////////////
//
// This program is free software; you can redistribute it and/or
// modify it under the terms of the GNU General Public License
// as published by the Free Software Foundation; either version 2
// of the License, or (at your option) any later version.
//
// This program is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
// GNU General Public License for more details.
//
// You should have received a copy of the GNU General Public License
// along with this program; if not, write to the Free Software
// Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
//
///////////////////////////////////////////////////////////////////////////////

require_once("../../gui/Webconfig.inc.php");
require_once("../../api/Amavis.class.php");
require_once("../../api/Daemon.class.php");
require_once("../../api/ClamAv.class.php");
require_once("../../api/Freshclam.class.php");
require_once("../../api/FileTypes.class.php");
require_once("mailfilter.php");
require_once(GlobalGetLanguageTemplate(__FILE__));

///////////////////////////////////////////////////////////////////////////////
//
// Header
//
///////////////////////////////////////////////////////////////////////////////

WebAuthenticate();
WebHeader(WEB_LANG_PAGE_TITLE);
WebDialogIntro(WEB_LANG_PAGE_TITLE, "/images/icon-mail-antivirus.png", WEB_LANG_PAGE_INTRO);

///////////////////////////////////////////////////////////////////////////////
//
// Handle Update
//
///////////////////////////////////////////////////////////////////////////////

$amavis = new Amavis();
$clamav = new ClamAv();
$filetype = new FileTypes();  // Locale tags

try {

	if (isset($_POST['StartDaemon'])) {
		$clamav->SetBootState(true);
		$clamav->SetRunningState(true);
		$freshclam = new Freshclam();
		$freshclam->SetBootState(true);
		$freshclam->SetRunningState(true);
		$amavis->SetAntivirusState(true);
		$amavis->SetBootState(true);
		if ($amavis->GetRunningState())
			$amavis->Reset();
		else
			$amavis->SetRunningState(true);
	} else if (isset($_POST['StopDaemon'])) {
		$amavis->SetAntivirusState(false);

		if (! $amavis->GetAntispamState()) {
			$amavis->SetBootState(false);
			$amavis->SetRunningState(false);
		} else {
			$amavis->Reset();
		}

	} else if (isset($_POST['UpdateConfig'])) {
		$amavis->SetAntivirusPolicy($_POST['antivirus_policy']);
		$amavis->SetBadHeaderPolicy($_POST['bad_header_policy']);
		$amavis->SetBannedPolicy($_POST['banned_files_policy']);
		$amavis->Reset();
	} else if (isset($_POST['UpdateExtensions']) && isset($_POST['extensions'])) {
		if (isset($_POST['extensions']))
			$amavis->SetBannedExtensions($_POST['extensions']);

		$amavis->Reset();
	}
} catch (Exception $e) {
	WebDialogWarning($e->GetMessage());
}

///////////////////////////////////////////////////////////////////////////////
//
// Main
//
///////////////////////////////////////////////////////////////////////////////

WebDialogMailFilter("clamd");
DisplayConfig();
DisplayBannedExtensions();
WebFooter();

///////////////////////////////////////////////////////////////////////////////
// F U N C T I O N S
///////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////////
//
// DisplayConfig()
//
///////////////////////////////////////////////////////////////////////////////

function DisplayConfig()
{
	global $amavis;


	try {
		$antivirus_policy = $amavis->GetAntivirusPolicy();
		$bad_header_policy = $amavis->GetBadHeaderPolicy();
		$banned_files_policy = $amavis->GetBannedPolicy();
	} catch (Exception $e) {
		WebDialogWarning($e->GetMessage());
		return;
	}

	$policy_options[Amavis::POLICY_PASS] = AMAVIS_LANG_PASS_THROUGH;
	$policy_options[Amavis::POLICY_DISCARD] = AMAVIS_LANG_DISCARD;
	$policy_options[Amavis::POLICY_QUARANTINE] = AMAVIS_LANG_QUARANTINE;

	$banned_files_policy_options = $policy_options;
	$banned_files_policy_options[Amavis::POLICY_BOUNCE] = AMAVIS_LANG_BOUNCE;

	$bad_header_policy_options = $policy_options;
	$bad_header_policy_options[Amavis::POLICY_BOUNCE] = AMAVIS_LANG_BOUNCE;

	$antivirus_policy_options = $policy_options;

	// HTML
	//-----


	WebFormOpen();
	WebTableOpen(WEB_LANG_MAIL_POLICIES, "450");
	echo "
		<tr>
			<td class='mytablesubheader' nowrap>" . AMAVIS_LANG_VIRUS_DETECTED_POLICY . "</td>
			<td>" . WebDropDownHash("antivirus_policy", $antivirus_policy, $antivirus_policy_options) . "</td>
		</tr>
		<tr>
			<td class='mytablesubheader' nowrap>" . AMAVIS_LANG_BAD_HEADER_POLICY . "</td>
			<td>" . WebDropDownHash("bad_header_policy", $bad_header_policy, $bad_header_policy_options) . "</td>
		</tr>
		<tr>
			<td class='mytablesubheader' nowrap>" . AMAVIS_LANG_BANNED_FILE_EXTENSION_POLICY . "</td>
			<td>" . WebDropDownHash("banned_files_policy", $banned_files_policy, $banned_files_policy_options) . "</td>
		</tr>
		<tr>
			<td class='mytablesubheader'>&#160; </td>
			<td>" . WebButtonUpdate("UpdateConfig") . "</td>
		</tr>
		<tr>
			<td colspan='2' class='mytablelegend'>" . 
				WEB_LANG_OTHER_ANTIVIRUS_ENGINE_OPTIONS . " &nbsp; " . 
				WebUrlJump("/admin/antivirus.php", LOCALE_LANG_CONFIGURE) . "
			</td>
		</tr>
	";
	WebTableClose("450");
	WebFormClose();
}

///////////////////////////////////////////////////////////////////////////////
//
// DisplayBannedExtensions()
//
///////////////////////////////////////////////////////////////////////////////

function DisplayBannedExtensions()
{
	global $amavis;

	try {
		$banned_extensions = $amavis->GetBannedExtensions();
		$file_extension_list = $amavis->GetBannedExtensionList();
	} catch (Exception $e) {
		WebDialogWarning($e->GetMessage());
		return;
	}

	$extension_list = "";
	$current_type = "";

	foreach ($file_extension_list as $extension => $info) {

		if ($current_type != $info['type']) {
			$current_type = $info['type'];
			$extension_list .= "
				<tr>
					<td colspan='2' class='mytableheader'>" . $info['typetext'] . "</td>
				</tr>
			";
		}

		if (in_array($extension, $banned_extensions)) {
			$checked = "checked";
			$class = "mytableenabled";
		} else {
			$checked = "";
			$class = "mytabledisabled";
		}

		$extension_list .= "
			<tr>
				<td class='$class' width='70'><input $checked type='checkbox' name='extensions[]' value='$extension' /> $extension</td>
				<td class='$class'>" . $info['description'] . "</td>
			</tr>
		";
	}

	WebFormOpen();
	WebTableOpen(WEB_LANG_BANNED_FILE_EXTENSION_LIST, "450");
	echo "
		$extension_list
		<tr>
			<td>&#160; </td>
			<td>" . WebButtonUpdate("UpdateExtensions") . "</td>
		</tr>
	";
	WebTableClose("450");
	WebFormClose();
}

// vim: syntax=php ts=4
?>
